{% extends 'base.html' %}

{% block title %}Send{% endblock %}

{% block head %}
    <style type="text/css">
        ul {
            list-style-type: none;
        }
    </style>
{% endblock %}

{% block content %}

    <form name="form-send" action="" method="post">
        {% csrf_token %}

        <!-- sidebar for selecting or entering message -->
        <div id="tabs-msg" class="container content sidebar-left">
            <h4>Select or Enter Your Message:</h4>
            <ul>
                <li><a href="#tabs-file">File</a></li>
                <li><a href="#tabs-data">Data</a></li>
            </ul>
            <div id="tabs-file">
                <!-- file list from data_store -->
                <div id="accordion-files">
                    {% for name, data in files.items %}
                        <h5 id="code-{{ name }}">{{ name }}</h5>
                        <div>
                            <pre style="height: 150px;">
                                <code>{{ data | linebreaksbr }}</code>
                            </pre>
                        </div>
                    {% endfor %}
                </div>
                <input id="msg-file" name="msg-file" type="hidden" value="{{ msg_file }}">
                <input id="msg-file-num" name="msg-file-num" type="hidden" value="{{ msg_file_num }}">
            </div>
            <div id="tabs-data">
                <p>Enter your message:</p>
                <textarea id="msg-data" name="msg-data" rows="15" style="width: 100%;"
                          class="ui-widget-content">{{ msg_data }}</textarea>
            </div>
            <input id="msg-source" name="msg-source" type="hidden" value="{{ msg_source }}">
        </div>


        <div class="container content" xmlns="http://www.w3.org/1999/html">

                <!-- MQ selections & configs -->
                <div id="tabs-mq">
                    <ul>
                        <li><a href="#tabs-rabbit">{{ MQTypes.RabbitMQ }}</a></li>
                        <li><a href="#tabs-kafka">{{ MQTypes.Kafka }}</a></li>
                    </ul>
                    <div id="tabs-rabbit">
                        <table style="width: 95%;">
                            <tr>
                                <td colspan="2">
                                    <p>Specify either "queue" or "exchange" + "key".</p>

                                    <p>Select a file (click left list) or enter your data.</p>
                                    <hr>
                                </td>
                            </tr>
                            <tr>
                                <td><label for="queue">queue:</label></td>
                                <td><input name="queue" type="text" style="width: 80%;" class="ui-widget-content"
                                           placeholder="queue name" value="{{ queue }}"></td>
                            </tr>
                            <tr>
                                <td><label for="exchange">exchange:</label></td>
                                <td><input name="exchange" type="text" style="width: 80%;" class="ui-widget-content"
                                           placeholder="exchange name" value="{{ exchange }}"></td>
                            </tr>
                            <tr>
                                <td><label for="key">key:</label></td>
                                <td><input name="key" type="text" style="width: 80%;" class="ui-widget-content"
                                           placeholder="binding key (for exchange only)" value="{{ key }}"></td>
                            </tr>
                        </table>
                    </div>
                    <div id="tabs-kafka">
                        <p>Kafka is not supported yet.</p>
                    </div>
                    <input id="mq" name="mq" type="hidden" value="{{ mq }}">
                </div>

                <!-- overriding plugins -->
                <div id="tabs-plugin">
                    <h4>Select plugins to override the message:</h4>
                    <ul>
                        {% for stack, plugin_names in stacks.items %}
                        <li><a href="#tabs-{{ stack }}">{{ stack }}</a></li>
                        {% endfor %}
                    </ul>
                    {% for stack, plugin_names in stacks.items %}
                    <div id="tabs-{{ stack }}">
                        <span style="display: none" id="span-{{ stack }}">{% for p in plugin_names %}{{ p }},{% endfor %}</span>
                        <ul>

                        </ul>
                    </div>
                    {% endfor %}
                </div>

                <!-- hidden plugin input forms -->
                <ul id="all-plugins" style="display: none">
                {% for plugin in plugins %}
                    <li id="form-{{ plugin.name }}">
                        <label for="chk{{ splitter }}{{ plugin.name }}">{{ plugin.name }}</label>
                        <input type="checkbox" id="chk{{ splitter }}{{ plugin.name }}"
                               name="plugin{{ splitter }}{{ plugin.name }}" class="plugin-sel"
                               {% if request.POST.plugin %}checked="true"{% endif %}>
                        {% if not plugin.plugin_object.is_auto_value %}
                        <input type="text" name="pluginv{{ splitter }}{{ plugin.name }}" value="{{ request.POST.plugin }}">
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>

                <div style="clear:both"><p></p></div>

                <!-- buttons -->
                <div>
{#                    <input type="submit" name="btn-submit" value="send"/>#}
{#                    <input type="reset" name="btn-reset" value="reset"/>#}
                    <input type="hidden" id="inp-stack" value="" />
                    <button type="submit">Send</button>
                    <button type="reset">Reset</button>
                </div>

        </div>

    </form>

{% endblock %}

{% block script %}
<script language="JavaScript">
    $("#accordion-files").accordion();
    $("#tabs-msg").tabs();
    $("#tabs-mq").tabs();
    $("#tabs-plugin").tabs();
    $(".plugin-sel").checkboxradio();
    $("button").button();

    // update selected file name
    $("#accordion-files").click(function () {
        var fname = $(".ui-accordion-header[aria-expanded$='true']").text();
        $("#msg-file").val(fname);
        $("#msg-file-num").val($("#accordion-files").accordion("option", "active"));
    });
    $("#accordion-files").accordion("option", "active", {{ msg_file_num | default:0 }});

    // message selection source
    $("#tabs-msg").click(function () {
        var src = $("#tabs-msg").find("li[aria-expanded$='true']").text();
        $("#msg-source").val(src);
    });
    if ("{{ msg_source }}" == "data")
        $("[href='#tabs-data").trigger("click");
    else
        $("#tabs-msg").click();

    // MQ selection
    $("#tabs-mq").click(function () {
        var src = $("#tabs-mq").find("li[aria-expanded$='true']").text();
        $("#mq").val(src);
    });
    if ("{{ mq }}" == "Kafka")
        $("[href='#tabs-kafka']").trigger("click");
    else
        $("#tabs-mq").click();


    // plugin tabs
    var tabs = $("#tabs-plugin").tabs().on("focus", "li", function() {
        load_plugins($(this).text());
    })
    load_plugins(tabs.find("li a")[0].text);

    function load_plugins(stack) {
        $("#inp-stack").val(stack);
        $.each($("#span-"+stack).text().split(","), function(i, obj) {
            if (!obj) return false;
            $("#form-"+obj).appendTo($("#tabs-"+stack).find("ul"));
        });
    }

</script>
{% endblock %}