{% extends 'base.html' %}{% load customer_tags %}

{% block title %}Plugins{% endblock %}

{% block head %}
    <style type="text/css">
        ul {
            list-style-type: none;
        }

        #source-list li span {
            padding-right: 20px;
        }

        #tabs-stack li .ui-icon-close { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer; }
        #tabs-stack li .ui-icon-pencil { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer; }
    </style>
{% endblock %}

{% block content %}

    <div class="container">

        <form name="form-plugin" action="" method="post">
            {% csrf_token %}
            <div class="controlgroup">
                <fieldset>
                    <legend>Available Plugins</legend>
                    <ul id="source-list" style="width:800px">
                    {% for plugin in plugins %}
                        <li id="{{ plugin.name }}">
                            <span><input name="status" type="checkbox" {% if plugin.is_activated %}
                                   checked=true {% endif %}>
                            </span><span>{{ plugin.name }}
                            </span><span>{{ plugin.author }}
                            </span><span>{{ plugin.version }}
                            </span><span>{{ plugin.description }}
                            </span>
                        </li>
                    {% endfor %}
                    </ul>
                </fieldset>
            </div>


            <div>
                <input class="ui-button" type="button" id="btn-add" name="btn-add" value="Add" />
                <input class="ui-button" type="submit" name="btn-submit" value="Save"/>
                <input class="ui-button" type="reset" name="btn-reset" value="Reset"/>
            </div>

            <!-- Group tabs. New or Edit. -->
            <div id="tabs-stack">
                <h4>Select plugins for your stack:</h4>
                <ul>
                </ul>
            </div>

            <div style="clear:both"></div>


        </form>
        <a id="hel lo" href="#" onclick="javascript:hello();">hello</a>

    </div>

{% endblock %}

{% block script %}
    <script language="javascript">

{#        $("#source-list").sortable({#}
{#            cursor : "move",#}
{#            helper : "clone",#}
{#            opacity: 0.5,#}
{#            placeholder: "sortable-placeholder",#}
{#            connectWith : "#target-list",#}
{#            scroll : true,#}
{#            tolerance: "pointer",#}
{#            revert : "invalid"#}
{#        });#}
{#        $("#source-list").disableSelection();#}
{##}
{#        $("#target-list").sortable({#}
{#            cursor : "move",#}
{#            helper : "clone",#}
{#            opacity: 0.5,#}
{#            placeholder: "sortable-placeholder",#}
{#            connectWith : "#source-list",#}
{#            scroll : true,#}
{#            tolerance: "pointer",#}
{#            revert : "invalid"#}
{#        });#}
{#        $("#target-list").disableSelection();#}


        // tabs
        var tabs = $( "#tabs-stack" ).tabs();
        var tabTemplate = "<li>" +
                "<a href='#{href}'>#{label}</a> " +
                "<input type='hidden' name='rename--#{label}' style='float:left' class='ui-widget-content ui-corner-all' value='#{label}'> " +
                "<span class='ui-icon ui-icon-pencil' role='presentation'>Edit</span> " +
                "<span class='ui-icon ui-icon-close' role='presentation'>Remove</span> " +
                "</li>";
        var tabContent = "<fieldset>" +
            {% for plugin in plugins %}
                "<label for='chk--#{stack}--{{ plugin.name }}'>{{ plugin.name }}</label>" +
                "<input type='checkbox' class='plugin-sel' name='stack--#{stack}--{{ plugin.name }}' id='chk--#{stack}--{{ plugin.name }}'>" +
            {% endfor %}
          "</fieldset>";

        var tabCounter = 0;


        // tab "remove" icon click
        tabs.on("click", "span.ui-icon-close", function () {
            var name = $(this).closest("li").find("a").text();
            if (confirm('*WARNING* Are you sure to delete plugin-stack "' + name + '" ?')) {
                var panelId = $(this).closest("li").remove().attr("aria-controls");
                $("#" + panelId).remove();
                tabs.tabs("refresh");
            }
        });

        // tab "edit" icon click
        tabs.on("click", "span.ui-icon-pencil", function () {
            var inp = $(this).closest("li").find("input");
            var lnk = $(this).closest("li").find("a");
            var icons = $(this).closest("li").find("span");

            function edit() {
                lnk.hide();
                icons.hide();
                inp.attr("type", "text");
                inp.val(lnk.text());
                inp.focus();

            };

            function edit_done() {
                inp.attr("type", "hidden");
                inp.val(inp.val().replace('--', '_'));
                lnk.text(inp.val());
                lnk.show();
                icons.show();
            };

            inp.on("keyup", function (event) {
                if (event.keyCode === $.ui.keyCode.ENTER) {
                    edit_done();
                }
            });

            inp.blur(function (event) {
                edit_done();
            });

            edit();

            tabs.tabs("refresh");
        });

        // function to add a tab.
        function addTab(title, content) {
            var label = title || ("Stack " + tabCounter),
                id = "tabs-" + tabCounter,
                li = $(tabTemplate.replace(/#\{href\}/g, "#" + id).replace(/#\{label\}/g, label)),
                tabContentHtml = tabContent.replace(/#\{stack\}/g, label);

            tabs.find(".ui-tabs-nav").append(li);
            $(this).closest("li").find("input").val(label);
            tabs.append("<div id='" + id + "'><p>" + tabContentHtml + "</p></div>");
            tabs.tabs("refresh");
            tabs.tabs("option", "active", tabCounter);
            tabCounter++;
        }

        // buttons
        $(".ui-button").button();
        $("#btn-add").click(function(event){
            addTab(null);

            // plugin checkbox styles
            $(".plugin-sel" ).checkboxradio({
                icon: false
            });
        });

        // add existed stacks
        {% for stack, plugins in stacks.items %}
        addTab("{{ stack }}");
            {% for plugin in plugins %}
                console.log(tabs.find("#chk--{{ stack }}--{{ plugin }}"));
            $("#chk--{{ stack }}--{{ plugin }}").prop("checked", true);
            {% endfor %}
        {% endfor %}
        $(".plugin-sel" ).checkboxradio({icon: false});


        function hello(){
            alert( $("#hel lo").length);
        }

    </script>
{% endblock %}